{% extends 'admin/base.html' %}

{% block head_tail %}
<script src="https://www.google.com/recaptcha/api.js" async defer></script>

{% endblock %}


{% block body %}
{% if current_user.is_authenticated and current_user.user_role.value == 1 %}
<h3 class="m-0">Hello {{current_user.name}},</h3>
<small class="text-muted">Let check your stats!</small>
<ul class="nav nav-tabs">
    <li class="nav-item">
        <a class="nav-link active" data-toggle="tab" href="#download">Lượt tải</a>
    </li>
    <li onclick="clickStatUpload()" class="nav-item">
        <a class="nav-link" data-toggle="tab" href="#upload">Lượt đăng</a>
    </li>
    <li onclick="clickStatView()" class="nav-item">
        <a class="nav-link" data-toggle="tab" href="#view">Lượt xem</a>
    </li>
    <li onclick="clickStatConversionRate()" class="nav-item">
        <a class="nav-link" data-toggle="tab" href="#conversionRate">Tỷ lệ chuyển đổi</a>
    </li>
    <li onclick="clickStatNewUser()" class="nav-item">
        <a class="nav-link" data-toggle="tab" href="#newUser">Người dùng mới</a>
    </li>
    <li onclick="clickTopTen()" class="nav-item">
        <a class="nav-link" data-toggle="tab" href="#topTen">Top 10</a>
    </li>
</ul>
<div id="myTabContent" class="tab-content">
    <div class="tab-pane fade active show" id="download">
        <div class="p-3 bg-light my-4 mx-5">
            <h5>Thống kê lượt download</h5>
            <div class="bs-component">
                <ul class="nav nav-pills">
                    <li class="nav-item">
                        <div class="form-group">
                            <label for="chartDownloadPeriod">Period *</label>
                            <select required class="form-control" id="chartDownloadPeriod">
                                <option value="hour">Giờ</option>
                                <option selected value="day">Ngày</option>
                                <option value="month">Tháng</option>
                                <option value="year">Năm</option>
                            </select>
                        </div>
                    </li>
                    <li class="nav-item">
                        <div class="form-group">
                            <label for="chartDownloadStartTime">Thời gian từ</label>
                            <input type="date" class="form-control" id="chartDownloadStartTime"
                                   placeholder="Thời gian bắt đầu">
                        </div>
                    </li>
                    <li class="nav-item">
                        <div class="form-group">
                            <label for="chartDownloadEndTime">Thời gian từ</label>
                            <input type="date" class="form-control" id="chartDownloadEndTime"
                                   placeholder="Thời gian bắt đầu">
                        </div>
                    </li>
                    <li class="nav-item">
                        <div class="form-group">

                            <label for="chartDownloadBtnReset"></label>
                            <input onclick="resetChartDownload()" id="chartDownloadBtnReset" type="button" value="Reset"
                                   class="mt-auto btn btn-outline-primary form-control"/>
                            </input>
                        </div>
                    </li>
                    <li class="nav-item">
                        <div class="form-group">
                            <label for="chartDownloadBtnSubmit"></label>
                            <input onclick="submitChartDownload()" id="chartDownloadBtnSubmit" type="button"
                                   value="Submit"
                                   class="mt-auto btn btn-primary form-control"/>
                        </div>

                    </li>
                </ul>
            </div>
            <div class="d-flex">
                <div class="col-8">
                    <canvas id="chartDownloads"></canvas>
                </div>
                <div class="col-4">
                    <canvas id="chartCateDownloads"></canvas>

                </div>
            </div>
        </div>
    </div>
    <div class="tab-pane fade" id="upload">
        <div class="p-3 bg-light my-4 mx-5">
            <h5>Thống kê lượt Uploads</h5>
            <div class="bs-component">
                <ul class="nav nav-pills">
                    <li class="nav-item">
                        <div class="form-group">
                            <label for="chartUploadPeriod">Period *</label>
                            <select required class="form-control" id="chartUploadPeriod">
                                <option value="hour">Giờ</option>
                                <option selected value="day">Ngày</option>
                                <option value="month">Tháng</option>
                                <option value="year">Năm</option>
                            </select>
                        </div>
                    </li>
                    <li class="nav-item">
                        <div class="form-group">
                            <label for="chartUploadStartTime">Thời gian từ</label>
                            <input type="date" class="form-control" id="chartUploadStartTime"
                                   placeholder="Thời gian bắt đầu">
                        </div>
                    </li>
                    <li class="nav-item">
                        <div class="form-group">
                            <label for="chartUploadEndTime">Thời gian từ</label>
                            <input type="date" class="form-control" id="chartUploadEndTime"
                                   placeholder="Thời gian bắt đầu">
                        </div>
                    </li>
                    <li class="nav-item">
                        <div class="form-group">

                            <label for="chartUploadBtnReset"></label>
                            <input onclick="resetChartUpload()" id="chartUploadBtnReset" type="button" value="Reset"
                                   class="mt-auto btn btn-outline-primary form-control"/>
                            </input>
                        </div>
                    </li>
                    <li class="nav-item">
                        <div class="form-group">
                            <label for="chartUploadBtnSubmit"></label>
                            <input onclick="submitChartUpload()" id="chartUploadBtnSubmit" type="button"
                                   value="Submit"
                                   class="mt-auto btn btn-primary form-control"/>
                        </div>

                    </li>
                </ul>
            </div>
            <div class="d-flex">
                <div class="col-8">
                    <canvas id="chartUploads"></canvas>
                </div>
                <div class="col-4">
                    <canvas id="chartCateUploads"></canvas>

                </div>
            </div>
        </div>
    </div>
    <div class="tab-pane fade" id="conversionRate">
        <div class="p-3 bg-light my-4 mx-5">
            <h5>Thống kê tỉ lệ chuyển đổi giữa view với download</h5>
            <div class="d-flex">
                <div class="col-12">
                    <canvas id="chartConversionRate"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="tab-pane fade" id="view">
        <div class="p-3 bg-light my-4 mx-5">
            <h5>Thống kê view</h5>
            <div class="d-flex">
                <div class="col-12">
                    <canvas id="chartViews"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="tab-pane fade" id="newUser">
        <div class="p-3 bg-light my-4 mx-5">
            <h5>Thống kê user mới</h5>
            <div class="d-flex">
                <div class="col-12">
                    <canvas id="chartNewUsers"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="tab-pane fade" id="topTen">
        <div class="p-3 bg-light my-4 mx-5">
            <h5>Top 10 tài liệu được yêu thích nhất</h5>
            <div>
                <div id="topTenContainer">
                    {% for d in top_ten_favour_docs %}
                    <div class="p-5 jumbotron d-flex no-wrap mb-3 w-100">
                        <div class="col-1">
                            <h1>{{ loop.index0 + 1 }}</h1>
                        </div>
                        <div class="col-2">
                            <img src="{{d.image}}"/>
                        </div>
                        <div class="col-8">
                            <p>{{d.doc}}</p>
                        </div>
                        <div class="col-2">
                            <p>{{d.famous}}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

</div>


{% else %}
<div class="p-3 justify-content-center d-flex">
    <form id="form-login" action="/admin/login" method="post" class="row g-3 bg-dark text-white m-3 p-4 shadow-sm w-75">
        <div class="col-md-12">
            <label for="username" class="form-label">Username</label>
            <input type="text" name="username" class="form-control" id="username">
        </div>
        <div class="col-md-12">
            <label for="password" class="form-label">Password</label>
            <input type="password" name="password" class="form-control" id="password">
        </div>
        <div class="col-12 mt-4 d-flex justify-content-center">
            <div class="g-recaptcha" data-sitekey="6Lc6fCMnAAAAAJDFAZxx98ZFiEUXENtCdiacVb2L"></div>
        </div>
        <div class="col-12 mt-4 d-flex justify-content-center">
            <button type="button" onclick="login()" class="btn btn-primary w-100">Sign in</button>
        </div>
    </form>
</div>
{% endif %}

{% endblock %}

{% block tail %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% if current_user.is_authenticated and current_user.user_role.value == 1 %}
<script>
        window.onload = function() {
            download_values = {{download_values}}
            download_labels = JSON.parse('{{ download_labels|tojson }}');
            drawBasicChart(download_values,download_labels,"chartDownloads", "Lượt tải", "bar")

            download_cate_values = {{download_cate_values}}
            download_cate_labels = JSON.parse('{{ download_cate_labels|tojson }}');
            drawBasicChart(download_cate_values,download_cate_labels,"chartCateDownloads", "Lượt tải", "doughnut")
        }

         function clickStatUpload() {
            const canvas = document.getElementById("chartUploads")
            var chart = Chart.getChart(canvas);
            if (chart)
                return
            fetch('/admin/stat-upload', {
                method: "post",
                body: JSON.stringify({
                    "period": "day",
                    "start_time": "",
                    "end_time": "",
                }),
                headers: {
                    "Content-Type": "application/json"
                }
            }).then(res => res.json()).then((data) => {
                if (data) {
                    console.log(data)
                    if (data['status'] == 200) {
                        uploadLabels = data["upload_labels"]
                        uploadValues = data["upload_values"]
                        drawBasicChart(uploadValues,uploadLabels,"chartUploads", "Lượt đăng", "bar")

                        uploadCateValues = data["upload_cate_values"]
                        uploadCateLabels = data["upload_cate_labels"]
                        drawBasicChart(uploadCateValues, uploadCateLabels, "chartCateUploads", "Lượt đăng", "doughnut")
                    }
                    else
                        alert("Nhập liệu không hợp lệ")
                }
            })
        }

        function clickStatConversionRate() {
                conversion_rate_values = JSON.parse('{{conversion_rate_values|tojson}}');
                conversion_rate_labels = JSON.parse('{{ conversion_rate_labels|tojson }}');
                drawBasicChart(conversion_rate_values,conversion_rate_labels,"chartConversionRate", "%", "bar")
        }

        function clickStatView() {
            const canvas = document.getElementById("chartViews")
            var chart = Chart.getChart(canvas);
            if (chart)
                return
            fetch('/admin/stat-view', {
                method: "post",
                body: JSON.stringify({
                    "start_time": "",
                    "end_time": "",
                }),
                headers: {
                    "Content-Type": "application/json"
                }
            }).then(res => res.json()).then((data) => {
                if (data) {
                    console.log(data)
                    if (data['status'] == 200) {
                        dataLabels = data["data_labels"]
                        dataValues = data["data_values"]
                        drawBasicChart(dataValues,dataLabels,"chartViews", "Lượt xem", "bar")
                    }
                    else
                        alert("Nhập liệu không hợp lệ")
                }
            })

        }

        function clickStatNewUser() {
            const canvas = document.getElementById("chartNewUsers")
            var chart = Chart.getChart(canvas);
            if (chart)
                return
            fetch('/admin/stat-new-user', {
                method: "post",
                body: JSON.stringify({
                    "period": "day",
                    "start_time": "",
                    "end_time": "",
                }),
                headers: {
                    "Content-Type": "application/json"
                }
            }).then(res => res.json()).then((data) => {
                if (data) {
                    console.log(data)
                    if (data['status'] == 200) {
                        dataLabels = data["data_labels"]
                        dataValues = data["data_values"]
                        drawBasicChart(dataValues,dataLabels,"chartNewUsers", "Người dùng", "bar")
                    }
                    else
                        alert("Nhập liệu không hợp lệ")
                }
            })

        }





</script>

<script src="{{ url_for('static', filename='js/admin/chart.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin/stat.js') }}"></script>
{% else %}
<script>

    async function verifyRecaptcha() {
        try {
            const token = grecaptcha.getResponse();

            const data = {
                token: token
            };

            const response = await fetch('/verify-recaptcha', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                return true;
            } else {
                return false;
            }
        } catch (error) {
            console.error(error);
            return false;
        }
    }

    async function login() {
        try {
            var success = await verifyRecaptcha();

            if (success) {
                const form = document.getElementById("form-login");
                form.submit();
            } else {
                alert("Xác minh không thành công");
            }
        } catch (error) {
            console.error(error);
            alert("Xác minh không thành công");
        }
    }


</script>
{% endif %}
{% endblock %}